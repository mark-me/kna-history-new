<div id="media-gallery" class="row g-3">
    {% if media %}
        {% for item in media %}
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-img-top bg-light position-relative" style="height: 200px;">
                    {% if item.type_media in ['foto', 'poster'] %}
                        <img src="{{ url_for('serve_thumbnail', rel_path=item.storage_path) }}" 
                             alt="{{ item.caption or item.filename }}"
                             class="w-100 h-100 object-fit-cover">
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <i class="bi bi-file-earmark fs-1 text-muted"></i>
                        </div>
                    {% endif %}
                    
                    <div class="position-absolute top-0 end-0 p-2">
                        <input type="checkbox" name="media_ids" value="{{ item.id_media }}" 
                               class="form-check-input media-checkbox">
                    </div>
                </div>
                
                <div class="card-body">
                    <h6 class="card-title text-truncate">{{ item.caption or item.filename }}</h6>
                    <p class="card-text small">
                        <span class="badge bg-info">{{ item.type_media }}</span>
                        {% if item.capture_date %}
                        <br><small class="text-muted">{{ item.capture_date.strftime('%d-%m-%Y') }}</small>
                        {% endif %}
                    </p>
                    
                    {% if item.appearances %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-people"></i> 
                            {% for appearance in item.appearances %}
                                {{ appearance.member.current_first_name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="editMedia({{ item.id_media }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" 
                                onclick="viewMedia({{ item.id_media }})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="col-12 mt-4">
            <div class="card bg-light">
                <div class="card-body">
                    <h6>Geselecteerde media toewijzen aan leden</h6>
                    <form method="POST" action="{{ url_for('bulk_assign_appearances', id_activity=activity_id) }}"
                          id="bulk-assign-form">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Selecteer leden</label>
                                <select name="member_ids" class="form-select" multiple size="5">
                                    {% for member in members|default([]) %}
                                    <option value="{{ member.id_member }}">
                                        {{ member.current_first_name }} {{ member.current_last_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd voor meerdere</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Optioneel: koppel aan rol</label>
                                <select name="role_ids" class="form-select" multiple size="5">
                                    <option value="">Geen rol</option>
                                    {% for role in roles|default([]) %}
                                    <option value="{{ role.id_role }}">
                                        {{ role.role_name }} - {{ role.member.current_first_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                Wijs geselecteerde media toe
                            </button>
                            <small class="text-muted ms-2">
                                <span id="selected-count">0</span> media items geselecteerd
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-images"></i> Nog geen media toegevoegd aan deze activiteit.
            <a href="{{ url_for('upload') }}" class="alert-link">Upload media</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.querySelectorAll('.media-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
});

function updateSelectedCount() {
    const count = document.querySelectorAll('.media-checkbox:checked').length;
    document.getElementById('selected-count').textContent = count;
    
    // Update form to only include checked items
    const form = document.getElementById('bulk-assign-form');
    form.querySelectorAll('input[name="media_ids"]').forEach(input => input.remove());
    
    document.querySelectorAll('.media-checkbox:checked').forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'media_ids';
        input.value = checkbox.value;
        form.appendChild(input);
    });
}
</script>
